<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title></title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      background-color: rgba(0, 0, 0, 0) !important;
      background: rgba(0, 0, 0, 0) !important;
      -webkit-user-select: none;
      user-select: none;
      overflow: hidden;
    }

    .pill {
      position: fixed;
      inset: 3px;
      border-radius: 999px;
      background: rgba(20, 20, 22, 0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      overflow: hidden;
      transition: box-shadow 0.18s ease, background 0.18s ease;
    }

    .pill[data-state="listening"] {
      background: rgba(26, 18, 8, 0.94);
      box-shadow:
        0 0 0 1.5px rgba(255, 140, 0, 0.80),
        0 0 8px 2px rgba(255, 140, 0, 0.25);
    }

    .pill[data-state="processing"] { cursor: default; }

    .drag {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      cursor: move;
    }
    .click {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      cursor: pointer;
      z-index: 2;
    }
    .pill[data-state="processing"] .click { pointer-events: none; }

    .icon-mic, .icon-stop {
      pointer-events: none;
      position: relative;
      z-index: 3;
      flex-shrink: 0;
    }
    .icon-stop { display: none; }
    .pill[data-state="listening"]  .icon-mic  { display: none; }
    .pill[data-state="listening"]  .icon-stop { display: block; }
    .pill[data-state="processing"] .icon-mic  { display: none; }
    .pill[data-state="processing"] .icon-stop { display: none; }

    .waveform {
      display: none;
      align-items: center;
      gap: 2px;
      height: 12px;
      pointer-events: none;
      position: relative;
      z-index: 3;
    }
    .pill[data-state="listening"] .waveform { display: flex; }
    .waveform span {
      display: block;
      width: 2px;
      border-radius: 1px;
      background: rgb(255, 138, 0);
      animation: wave 0.85s ease-in-out infinite;
    }
    .waveform span:nth-child(1) { height: 3px;  animation-delay: 0s; }
    .waveform span:nth-child(2) { height: 7px;  animation-delay: 0.11s; }
    .waveform span:nth-child(3) { height: 11px; animation-delay: 0.22s; }
    .waveform span:nth-child(4) { height: 7px;  animation-delay: 0.33s; }
    .waveform span:nth-child(5) { height: 3px;  animation-delay: 0.44s; }
    @keyframes wave {
      0%, 100% { transform: scaleY(1); }
      50%       { transform: scaleY(1.8); }
    }

    .spinner {
      display: none;
      width: 11px;
      height: 11px;
      border: 1.5px solid rgba(255,255,255,0.12);
      border-top-color: rgba(255,255,255,0.80);
      border-radius: 50%;
      animation: spin 0.65s linear infinite;
      pointer-events: none;
      position: relative;
      z-index: 3;
      flex-shrink: 0;
    }
    .pill[data-state="processing"] .spinner { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .label {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: -0.01em;
      color: rgba(255, 255, 255, 0.82);
      white-space: nowrap;
      pointer-events: none;
      position: relative;
      z-index: 3;
    }
    .pill[data-state="listening"]  .label { color: rgba(255, 165, 38, 0.95); }
    .pill[data-state="processing"] .label { color: rgba(255, 255, 255, 0.38); }
  </style>
</head>
<body>
  <div class="pill" id="pill" data-state="idle">
    <div class="drag" data-tauri-drag-region="true"></div>
    <div class="click" id="click"></div>

    <svg class="icon-mic" width="10" height="10" viewBox="0 0 24 24" fill="none"
         stroke="rgba(255,255,255,0.80)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="2" width="6" height="12" rx="3"/>
      <path d="M5 10a7 7 0 0 0 14 0"/>
      <line x1="12" y1="19" x2="12" y2="22"/>
      <line x1="9" y1="22" x2="15" y2="22"/>
    </svg>

    <svg class="icon-stop" width="9" height="9" viewBox="0 0 24 24" fill="rgb(255,138,0)" stroke="none">
      <rect x="5" y="5" width="14" height="14" rx="3"/>
    </svg>

    <div class="waveform" aria-hidden="true">
      <span></span><span></span><span></span><span></span><span></span>
    </div>

    <div class="spinner" aria-hidden="true"></div>

    <span class="label" id="label">Dictate</span>
  </div>

  <script>
    (function () {
      const pill  = document.getElementById('pill');
      const label = document.getElementById('label');
      const click = document.getElementById('click');

      let state = 'idle';

      function setState(s) {
        if (s === 'error') {
          label.textContent = 'Error';
          pill.setAttribute('data-state', 'idle');
          setTimeout(() => { state = 'idle'; label.textContent = 'Dictate'; }, 1400);
          return;
        }
        state = s;
        pill.setAttribute('data-state', s);
        label.textContent = s === 'listening' ? 'Listening…' : s === 'processing' ? 'Processing…' : 'Dictate';
      }

      function getInvoke() {
        return window.__TAURI__?.core?.invoke ?? window.__TAURI__?.tauri?.invoke ?? null;
      }

      click.addEventListener('click', async () => {
        if (state === 'processing') return;
        const invoke = getInvoke();
        if (!invoke) return;
        if (state === 'idle') {
          try { await invoke('start_native_dictation'); setState('listening'); }
          catch (e) { console.error(e); setState('error'); }
        } else if (state === 'listening') {
          setState('processing');
          try { await invoke('stop_native_dictation'); }
          catch (e) { console.error(e); setState('error'); }
        }
      });

      const ev = window.__TAURI__?.event;
      if (ev?.listen) {
        ev.listen('dictation:state-changed', ({ payload }) => setState(payload?.state ?? 'idle')).catch(() => {});
        ev.listen('dictation:hotkey-triggered', () => { if (state !== 'processing') click.click(); }).catch(() => {});
      }
    })();
  </script>
</body>
</html>
